deploy:
  needs: build
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region:            ${{ secrets.AWS_REGION }}

    - name: Update kubeconfig
      uses: aws-actions/eks-update-kubeconfig@v1
      with:
        region:       ${{ secrets.AWS_REGION }}
        cluster-name: ${{ secrets.EKS_CLUSTER_NAME }}

    - name: Create namespace
      run: kubectl apply -f namespace.yaml

    - name: Deploy application
      env:
        IMAGE: ${{ needs.build.outputs.image }}
        NAMESPACE: ${{ env.K8S_NAMESPACE }}
      run: |
        sed -i "s|image: .*|image: $IMAGE|" deployment.yaml
        kubectl apply -f deployment.yaml
        kubectl apply -f service.yaml
        kubectl rollout status deployment/calci-deployment \
          --namespace "$NAMESPACE" \
          --timeout 120s
